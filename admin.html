<!--
  Panneau d'administration - Synth√®ses Acad√©miques
  
  Cette page permet aux administrateurs de g√©rer les synth√®ses acad√©miques.
  Fonctionnalit√©s principales :
  - Authentification par mot de passe
  - Affichage de tous les fichiers avec filtrage et recherche
  - Modification des informations des fichiers (titre, cours, etc.)
  - Conversion de fichiers PDF/ZIP en liens vid√©o
  - Suppression de fichiers
  - Ajout de messages manuels dans chat.json
  - Affichage des messages depuis chat.json
  - Affichage des logs de modifications/suppressions depuis logs.json
  
  La page utilise JavaScript vanilla pour les interactions et communique
  avec le backend Node.js via des requ√™tes fetch API. Les styles sont
  d√©finis dans le fichier admin.css s√©par√©.
  
  @author: Thomas Bauwens
  @date: Mai 2025
  @lastModified: 3 septembre 2025
-->

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Administration - Synth√®ses Acad√©miques</title>
  <link rel="stylesheet" href="style/style.css">
  <link rel="stylesheet" href="style/admin.css?v=7">
  <style>
    .delete-btn { background:#e74c3c; color:white; }
    .edit-btn { background:#3498db; color:white; }
  </style>
</head>
<body>
  <!-- Connexion -->
  <div class="admin-container" id="loginContainer">
    <div class="login-form">
      <h2 class="admin-title">Administration</h2>
      <input type="password" id="password" placeholder="Mot de passe">
      <button onclick="login()">Connexion</button>
      <p id="loginError" style="color:red;display:none;">Mot de passe incorrect</p>
    </div>
  </div>

    <div id="cookiePopup" style="display: none; position: fixed; bottom: 20px; right: 20px; background: #fff; padding: 20px; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1); z-index: 1000;">
    <h2>Consentement aux cookies</h2>
    <p>Nous utilisons des cookies pour am√©liorer votre exp√©rience. Acceptez-vous leur utilisation ?</p>
    <button id="acceptCookies">J'accepte</button>
    <button id="refuseCookies">Je refuse</button>
</div>

  <!-- Panneau Admin -->
  <div class="admin-container" id="adminPanel" style="display:none;">
    <div class="admin-header">
      <h2>Panneau d'administration</h2>
      <button onclick="logout()">D√©connexion</button>
    </div>

<!-- Cadre pour ajouter un message manuel -->
<div class="message-form">
  <h3>Ajouter un message</h3>
  <form id="messageForm">
    <div class="form-group">
      <label for="messageNom">Nom</label>
      <input type="text" id="messageNom" class="form-control" placeholder="Votre nom ou Discord">
    </div>
    <div class="form-group">
      <label for="messageText">Message</label>
      <textarea id="messageText" class="form-control" placeholder="√âcrivez votre message ici" rows="1"></textarea>
    </div>
    <div class="form-actions">
      <button type="button" class="save-btn" onclick="sendMessage()">Envoyer</button>
    </div>
  </form>
</div>

    <!-- Cadre pour afficher les messages -->
    <div class="messages-list">
      <h3>Messages enregistr√©s</h3>
      <table class="messages-table">
        <thead>
          <tr>
            <th>Date & Heure</th>
            <th>Nom</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody id="messagesTableBody"></tbody>
      </table>
    </div>

    <!-- Cadre pour afficher les logs -->
    <div class="logs-list">
      <h3>Logs des modifications/suppressions</h3>
      <table class="logs-table">
        <thead>
          <tr>
            <th>Date & Action</th>
          </tr>
        </thead>
        <tbody id="logsTableBody"></tbody>
      </table>
    </div>

    <!-- üîé Filtres -->
    <div class="filter-options">
      <input type="text" id="searchInput" placeholder="Rechercher...">
      <select id="anneeFilter">
        <option value="">Toutes les ann√©es</option>
        <option value="1">1√®re ann√©e</option>
        <option value="2">2√®me ann√©e</option>
        <option value="3">3√®me ann√©e</option>
      </select>
      <select id="coursFilter">
        <option value="">Tous les cours</option>
      </select>
      <select id="typeFilter">
        <option value="">Tous les types</option>
        <option value="pdf">PDF</option>
        <option value="zip">ZIP</option>
        <option value="video">Vid√©o</option>
      </select>
    </div>

    <!-- üìë Tableau des fichiers -->
    <div class="table-container">
      <table class="file-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Ann√©e</th>
            <th>Type</th>
            <th>Titre</th>
            <th>Cours</th>
            <th>Nom/Discord</th>
            <th>Taille</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="fileTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- üìù Modal Edition -->
  <div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Modifier un fichier</h3>
      <form id="editForm">
        <input type="hidden" id="editId">
        <p><b>ID :</b> <span id="displayId"></span></p>
        <div class="form-group">
          <label for="editAnnee">Ann√©e</label>
          <select id="editAnnee">
            <option value="1">1√®re ann√©e</option>
            <option value="2">2√®me ann√©e</option>
            <option value="3">3√®me ann√©e</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editCours">Cours</label>
          <select id="editCours"></select>
        </div>
        <div class="form-group">
          <label for="editTitre">Titre</label>
          <input type="text" id="editTitre">
        </div>
        <div class="form-group">
          <label for="editNom">Nom/Discord</label>
          <input type="text" id="editNom">
        </div>
        <div class="form-group">
          <label for="editDescription">Description</label>
          <textarea id="editDescription"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" onclick="closeModal()">Annuler</button>
          <button type="button" onclick="saveChanges()">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const allFiles = [];

    // üìö Liste des cours par ann√©e
    const coursParAnnee = {
      1: ["STRUCTURE DE DONNEES","MATHEMATIQUE 1","MATHEMATIQUE 2","BASE DE DONNEES",
          "SYSTEMES D'EXPLOITATION / LINUX","JAVASCRIPT","ANGLAIS","ALGO","APOO",
          "FONCTIONNEMENT DES ORDINATEURS","GESTION COMPTABILITE ECONOMIE",
          "COMPETENCES NUMERIQUES","DIVERS"],
      2: ["LANGAGE C : BASE","ANALYSE ET MODELISATION","GESTION DE DONNEES","PROGRAMMATION JAVA",
          "DEVELOPPEMENT WEB","DEVOPS","INTRODUCTION AUX RESEAUX","STRUCTURES DE DONNEES",
          "ORGANISATION DES ENTREPRISES","CONCEPTION D'APPLICATIONS D'ENTREPRISE",
          "LINUX : PROGRAMMATION DISTRIBUEE","INFORMATIQUE MOBILE","ANGLAIS 2","DIVERS"],
      3: ["ADMINISTRATION INFRASTRUCTURE","ORGANISATION DES ENTREPRISES","ANGLAIS 3",
          "PROGRAMMATION : QUESTIONS SPECIALES","DEVELOPPEMENT WEB",
          "PROJET DE FIN D'ETUDE : ASTUCES","INTEGRATION EN MILIEU PROFESSIONNEL",
          "DEVELOPPEMENT A L'AIDE D'UN MOTEUR DE JEUX (UNITY)","INTELLIGENCE ARTIFICIELLE",
          "CYBERSECURITE ET MALWARES","DIVERS"]
    };

    // ‚úÖ Login
    async function login() {
      const password = document.getElementById("password").value;
      try {
        const res = await fetch('/admin/login', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password })
        });
        const data = await res.json();
        if (data.success) {
          document.getElementById("loginContainer").style.display = "none";
          document.getElementById("adminPanel").style.display = "block";
          loadFiles();
          loadMessages();
          loadLogs();
        } else {
          document.getElementById("loginError").style.display = "block";
        }
      } catch {
        document.getElementById("loginError").style.display = "block";
      }
    }

    function logout() {
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("loginContainer").style.display = "block";
    }

    // ‚úÖ Charger fichiers
    async function loadFiles() {
      const res = await fetch('/get-files');
      const data = await res.json();
      allFiles.length = 0;
      data.forEach(f => allFiles.push(f));
      populateCoursFilter(allFiles);
      filterFiles();
    }

    // Charger messages
async function loadMessages() {
  try {
    const res = await fetch('/get-messages');
    const messages = await res.json();
    const tbody = document.getElementById("messagesTableBody");
    tbody.innerHTML = "";
    if (!messages.length) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">Aucun message trouv√©</td></tr>`;
      return;
    }
    // Trier par date d√©croissante (dernier en haut)
    const sortedMessages = [...messages].sort((a, b) => new Date(b.date) - new Date(a.date));
    if (sortedMessages.length > 3) {
      // Cr√©er une liste d√©roulante pour plus de 3 messages
      const select = document.createElement("select");
      select.className = "message-dropdown";
      select.size = Math.min(sortedMessages.length, 10); // Limite √† 10 visibles max
      sortedMessages.forEach(m => {
        const option = document.createElement("option");
        option.value = `${m.date} - ${m.nom} - ${m.message}`;
        option.textContent = `${m.date} - ${m.nom} - ${m.message}`;
        select.appendChild(option);
      });
      tbody.appendChild(select);
    } else {
      // Afficher sous forme de table pour 3 ou moins
      sortedMessages.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${m.date}</td>
          <td>${m.nom}</td>
          <td>${m.message}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (error) {
    console.error('Erreur lors du chargement des messages:', error);
    alert('Erreur lors du chargement des messages');
  }
}

// Charger logs
async function loadLogs() {
  try {
    const res = await fetch('/get-logs');
    const logs = await res.json();
    const tbody = document.getElementById("logsTableBody");
    tbody.innerHTML = "";
    if (!logs.length) {
      tbody.innerHTML = `<tr><td style="text-align:center">Aucun log trouv√©</td></tr>`;
      return;
    }
    // Trier par date d√©croissante (dernier en haut)
    const sortedLogs = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));
    if (sortedLogs.length > 3) {
      // Cr√©er une liste d√©roulante pour plus de 3 logs
      const select = document.createElement("select");
      select.className = "log-dropdown";
      select.size = Math.min(sortedLogs.length, 10); // Limite √† 10 visibles max
      sortedLogs.forEach(log => {
        const option = document.createElement("option");
        option.value = `${log.date} - ${log.action}`;
        option.textContent = `${log.date} - ${log.action}`;
        select.appendChild(option);
      });
      tbody.appendChild(select);
    } else {
      // Afficher sous forme de table pour 3 ou moins
      sortedLogs.forEach(log => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${log.date} - ${log.action}</td>
        `;
        tbody.appendChild(tr);
      });
    }
  } catch (error) {
    console.error('Erreur lors du chargement des logs:', error);
    alert('Erreur lors du chargement des logs');
  }
}

    // G√©n√®re les options du filtre cours
    function populateCoursFilter(files) {
      const coursFilter = document.getElementById("coursFilter");
      const cours = [...new Set(files.map(f => f.cours))].sort();
      coursFilter.innerHTML = '<option value="">Tous les cours</option>';
      cours.forEach(c => { coursFilter.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    // Tri et affichage
    function displayFiles(files) {
      const tbody = document.getElementById("fileTableBody");
      tbody.innerHTML = "";
      if (!files.length) {
        tbody.innerHTML = `<tr><td colspan="9" style="text-align:center">Aucun fichier trouv√©</td></tr>`;
        return;
      }
      const sorted = [...files].sort((a, b) => b.id - a.id);
      sorted.forEach(f => {
        const sizeMB = f.poidsFichier ? (f.poidsFichier / 1048576).toFixed(2) + " MB" : "N/A";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${f.id}</td>
          <td>${f.annee}</td>
          <td>${f.type.toUpperCase()}</td>
          <td>${f.titre}</td>
          <td>${f.cours}</td>
          <td>${f.nomDiscord}</td>
          <td>${sizeMB}</td>
          <td>${f.dateAjout}</td>
          <td>
            <button class="edit-btn" onclick="editFile(${f.id})">Modifier</button>
            <button class="delete-btn" onclick="deleteFile(${f.id})">Supprimer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filtres
    function filterFiles() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const anneeFilter = document.getElementById("anneeFilter").value;
      const coursFilter = document.getElementById("coursFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const filtered = allFiles.filter(f => {
        const matchesS = f.titre.toLowerCase().includes(search) || f.cours.toLowerCase().includes(search) || (f.nomDiscord || "").toLowerCase().includes(search);
        const matchesA = !anneeFilter || String(f.annee) === anneeFilter;
        const matchesC = !coursFilter || f.cours === coursFilter;
        const matchesT = !typeFilter || f.type === typeFilter;
        return matchesS && matchesA && matchesC && matchesT;
      });
      displayFiles(filtered);
    }

    // Edition
    function editFile(id) {
      const f = allFiles.find(f => f.id === id);
      if (!f) return;
      document.getElementById("editId").value = f.id;
      document.getElementById("displayId").textContent = f.id;
      document.getElementById("editTitre").value = f.titre;
      document.getElementById("editNom").value = f.nomDiscord;
      document.getElementById("editDescription").value = f.description || "";
      document.getElementById("editAnnee").value = f.annee;
      fillCoursSelect(f.annee, f.cours);
      document.getElementById("editModal").style.display = "block";
      document.getElementById("editAnnee").addEventListener("change", function() {
        fillCoursSelect(this.value);
      });
    }

    function fillCoursSelect(annee, current="") {
      const select = document.getElementById("editCours");
      select.innerHTML = "";
      (coursParAnnee[annee] || []).forEach(c => {
        const opt = document.createElement("option");
        opt.value = c; opt.textContent = c;
        if (c === current) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function closeModal() { document.getElementById("editModal").style.display = "none"; }

    // Sauver modifications
    async function saveChanges() {
      const id = parseInt(document.getElementById("editId").value);
      const updates = {
        annee: parseInt(document.getElementById("editAnnee").value),
        cours: document.getElementById("editCours").value,
        titre: document.getElementById("editTitre").value,
        nomDiscord: document.getElementById("editNom").value,
        description: document.getElementById("editDescription").value
      };
      try {
        const res = await fetch("/edit-file", {
          method: "POST", headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ id, ...updates })
        });
        const data = await res.json();
        if (data.success) {
          loadFiles();
          loadLogs();
          closeModal();
          alert("Fichier modifi√© avec succ√®s");
        } else {
          alert("Erreur: " + data.message);
        }
      } catch (error) {
        alert("Erreur lors de la modification");
        console.error('Erreur:', error);
      }
    }

    // Suppression
    async function deleteFile(id) {
      if (!confirm("Voulez-vous vraiment supprimer ce fichier ?")) return;
      try {
        const res = await fetch(`/delete-file/${id}`, { method: "DELETE" });
        const data = await res.json();
        if (data.success) {
          loadFiles();
          loadLogs();
          alert("Fichier supprim√© avec succ√®s");
        } else {
          alert("Erreur: " + data.message);
        }
      } catch {
        alert("Erreur lors de la suppression");
      }
    }

    // Ajouter un message
    async function sendMessage() {
      const nom = document.getElementById("messageNom").value.trim();
      const message = document.getElementById("messageText").value.trim();
      if (!nom || !message) {
        alert("Veuillez remplir tous les champs.");
        return;
      }
      if (nom.length > 50) {
        alert("Le nom ne doit pas d√©passer 50 caract√®res.");
        return;
      }
      if (message.length > 500) {
        alert("Le message ne doit pas d√©passer 500 caract√®res.");
        return;
      }
      try {
        const res = await fetch('/add-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nom, message })
        });
        const data = await res.json();
        if (data.success) {
          alert("Message ajout√© avec succ√®s !");
          document.getElementById("messageForm").reset();
          loadMessages();
        } else {
          alert("Erreur : " + data.message);
        }
      } catch (error) {
        alert("Erreur lors de l'envoi du message.");
        console.error('Erreur:', error);
      }
    }

    // Listeners filtres
    document.getElementById("anneeFilter").addEventListener("change", () => {
      const year = document.getElementById("anneeFilter").value;
      populateCoursFilter(allFiles.filter(f => !year || String(f.annee) === year));
      filterFiles();
    });
    document.getElementById("coursFilter").addEventListener("change", filterFiles);
    document.getElementById("typeFilter").addEventListener("change", filterFiles);
    document.getElementById("searchInput").addEventListener("input", filterFiles);
  </script>

    <!-- Script cookiesConsent -->
  <script src="cookiesConsent.js"></script>
</body>
</html>