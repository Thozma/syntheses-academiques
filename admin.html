<!-- Site web de partage de synth√®ses acad√©miques - ADMINISTRATION
@author: Thomas Bauwens
@date : mai 2025
@modifi√©Date : 18 septembre 2025 
-->

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Administration - Synth√®ses Acad√©miques</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style/style.css">
    <link rel="stylesheet" href="style/admin.css?v=8">
    <style>
        .delete-btn {
            background: #e74c3c;
            color: #fff;
        }

        .edit-btn {
            background: #3498db;
            color: #fff;
        }
    </style>
</head>

<body>
    <!-- Connexion -->
    <div class="admin-container" id="loginContainer">
        <div class="login-form">
            <h2 class="admin-title">Administration</h2>
            <input type="password" id="password" placeholder="Mot de passe">
            <button onclick="login()">Connexion</button>
            <p id="loginError" style="color:red;display:none;">Mot de passe incorrect</p>
        </div>
    </div>

    <!-- Cookies -->
    <div id="cookiePopup"
        style="display:none; position:fixed; bottom:20px; right:20px; background:#fff; padding:20px; border:1px solid #ccc; border-radius:5px; box-shadow:0 0 10px rgba(0,0,0,.1); z-index:1000;">
        <h2>Consentement aux cookies</h2>
        <p>Nous utilisons des cookies pour am√©liorer votre exp√©rience. Acceptez-vous leur utilisation ?</p>
        <button id="acceptCookies">J'accepte</button>
        <button id="refuseCookies">Je refuse</button>
    </div>

    <!-- Panneau Admin -->
    <div class="admin-container" id="adminPanel" style="display:none;">
        <div class="admin-header">
            <h2>Panneau d'administration</h2>
            <button onclick="logout()" class="logout-btn">D√©connexion</button>
        </div>

        <!-- Activit√© (Messages puis Logs empil√©s) -->
        <section class="activity">
            <div class="card">
                <div class="card-head">
                    <h3>Messages enregistr√©s</h3>
                    <button class="collapse-btn">‚ñ≤</button> 
                    <div class="card-actions">


                    </div>
                </div>
                <div class="card-body" style="display: none;">
                    <!-- Formulaire message (conserv√©) -->
                    <div class="message-form">
                        <h3>Ajouter un message</h3>
                        <form id="messageForm">
                            <div class="form-group">
                                <label for="messageNom">Nom</label>
                                <input type="text" id="messageNom" class="form-control"
                                    placeholder="Votre nom ou Discord">
                            </div>
                            <div class="form-group">
                                <label for="messageText">Message</label>
                                <textarea id="messageText" class="form-control" placeholder="√âcrivez votre message ici"
                                    rows="2"></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="save-btn" onclick="sendMessage()">Envoyer</button>
                            </div>
                        </form>
                    </div>

                    <div class="table-wrap scroll-220">
                        <table class="messages-table">
                            <thead>
                                <tr>
                                    <th>Date & Heure</th>
                                    <th>Nom</th>
                                    <th>Message</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="messagesTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-head">
                    <h3>Logs des modifications/suppressions</h3>
                     <button class="collapse-btn">‚ñ≤</button>
                    <div class="card-actions">
                        <button id="clearLogs" class="btn danger sm" type="button">Tout supprimer</button>
                    </div>
                </div>
                <div class="card-body" style="display: none;">
                    <div class="table-wrap scroll-220">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th>Date & Action</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtres -->
        <div class="filter-options">
            <input type="text" id="searchInput" placeholder="Rechercher...">
            <select id="anneeFilter">
                <option value="">Toutes les ann√©es</option>
                <option value="1">1√®re ann√©e</option>
                <option value="2">2√®me ann√©e</option>
                <option value="3">3√®me ann√©e</option>
            </select>
            <select id="coursFilter">
                <option value="">Tous les cours</option>
            </select>
            <select id="typeFilter">
                <option value="">Tous les types</option>
                <option value="pdf">PDF</option>
                <option value="zip">ZIP</option>
                <option value="video">Vid√©o</option>
            </select>
            <select id="anneeScolaireFilter">
                <option value="">Ann√©es scolaires</option>
                <option value="2021-2022">2021-2022</option>
                <option value="2022-2023">2022-2023</option>
                <option value="2023-2024">2023-2024</option>
                <option value="2024-2025">2024-2025</option>
                <option value="2025-2026">2025-2026</option>
            </select>
            <span class="muted" id="countInfo"></span>
        </div>

        <!-- Tableau fichiers -->
        <div class="table-container">
            <table class="file-table">
                <thead>
    <tr>
        <th>ID</th>
        <th>Ann√©e</th>
        <th>Ann√©e Scolaire</th>
        <th>Titre</th>
        <th>Type</th>
        <th>Cours</th>
        <th>Nom/Discord</th>
        <th>Taille</th>
        <th>Date</th>
<th>üëç</th>
<th>üëé</th>
        <th>Actions</th>
    </tr>
</thead>
                <tbody id="fileTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Edition -->
    <div id="editModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h3>Modifier un fichier</h3>
            <form id="editForm">
                <input type="hidden" id="editId">
                <p><b>ID :</b> <span id="displayId"></span></p>

                <div class="form-group">
                    <label for="editAnnee">Ann√©e</label>
                    <select id="editAnnee">
                        <option value="1">1√®re ann√©e</option>
                        <option value="2">2√®me ann√©e</option>
                        <option value="3">3√®me ann√©e</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editAnneeScolaire">Ann√©e scolaire</label>
                    <select id="editAnneeScolaire">
                        <option value="2021-2022">2021-2022</option>
                        <option value="2022-2023">2022-2023</option>
                        <option value="2023-2024">2023-2024</option>
                        <option value="2024-2025">2024-2025</option>
                        <option value="2025-2026">2025-2026</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="editCours">Cours</label>
                    <select id="editCours"></select>
                </div>

                <div class="form-group">
                    <label for="editTitre">Titre</label>
                    <input type="text" id="editTitre">
                </div>

                <div class="form-group">
                    <label for="editNom">Nom/Discord</label>
                    <input type="text" id="editNom">
                </div>

                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription"></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="cancel-btn" onclick="closeModal()">Annuler</button>
                    <button type="button" class="save-btn" onclick="saveChanges()">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Votre script existant -->
    <script>
        document.getElementById('password').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') { event.preventDefault(); login(); }
        });

        async function checkSession() {
            const res = await fetch('/api/check-session');
            const data = await res.json();
            if (data.authenticated) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadFiles(); loadMessages(); loadLogs();
            }
        }
        window.onload = () => { checkSession(); };

        const allFiles = [];
        const coursParAnnee = {
            1: ["STRUCTURE DE DONNEES", "MATHEMATIQUE 1", "MATHEMATIQUE 2", "BASE DE DONNEES", "SYSTEMES D'EXPLOITATION / LINUX", "JAVASCRIPT", "ANGLAIS", "ALGO", "APOO", "FONCTIONNEMENT DES ORDINATEURS", "GESTION COMPTABILITE ECONOMIE", "COMPETENCES NUMERIQUES", "DIVERS"],
            2: ["LANGAGE C BASE", "ANALYSE ET MODELISATION", "GESTION DE DONNEES", "PROGRAMMATION JAVA", "DEVELOPPEMENT WEB", "DEVOPS", "INTRODUCTION AUX RESEAUX", "STRUCTURES DE DONNEES", "ORGANISATION DES ENTREPRISES", "CONCEPTION D'APPLICATIONS D'ENTREPRISE", "LINUX : PROGRAMMATION DISTRIBUEE", "INFORMATIQUE MOBILE", "ANGLAIS 2", "DIVERS"],
            3: ["ADMINISTRATION INFRASTRUCTURE", "ORGANISATION DES ENTREPRISES", "ANGLAIS 3", "PROGRAMMATION : QUESTIONS SPECIALES", "DEVELOPPEMENT WEB", "PROJET DE FIN D'ETUDE : ASTUCES", "INTEGRATION EN MILIEU PROFESSIONNEL", "DEVELOPPEMENT A L'AIDE D'UN MOTEUR DE JEUX (UNITY)", "INTELLIGENCE ARTIFICIELLE", "CYBERSECURITE ET MALWARES", "DIVERS"]
        };

        async function login() {
            const password = document.getElementById("password").value;
            try {
                const res = await fetch('/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) });
                const data = await res.json();
                if (data.success) {
                    document.getElementById("loginContainer").style.display = "none";
                    document.getElementById("adminPanel").style.display = "block";
                    loadFiles(); loadMessages(); loadLogs();
                } else { document.getElementById("loginError").style.display = "block"; }
            } catch { document.getElementById("loginError").style.display = "block"; }
        }
        function logout() { document.getElementById("adminPanel").style.display = "none"; document.getElementById("loginContainer").style.display = "block"; }

        async function loadFiles() {
            const res = await fetch('/get-files'); const data = await res.json();
            allFiles.length = 0; data.forEach(f => allFiles.push(f));
            populateCoursFilter(allFiles); filterFiles();
        }

        async function loadMessages() {
            try {
                const res = await fetch('/get-messages');
                const messages = await res.json();
                const tbody = document.getElementById("messagesTableBody");
                tbody.innerHTML = "";

                if (!messages.length) {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center">Aucun message trouv√©</td></tr>`;
                    return;
                }

                // Trie du plus r√©cent au plus ancien
                const sorted = [...messages].sort((a, b) => new Date(b.date) - new Date(a.date));

                sorted.forEach(m => {
                    const tr = document.createElement("tr");

                    // Colonne Date
                    const tdDate = document.createElement("td");
                    tdDate.textContent = m.date;

                    // Colonne Nom
                    const tdNom = document.createElement("td");
                    tdNom.textContent = m.nom;

                    // Colonne Message
                    const tdMessage = document.createElement("td");
                    tdMessage.textContent = m.message;

                    // Colonne Actions (Supprimer)
                    const tdActions = document.createElement("td");
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Supprimer";
                    deleteBtn.className = "delete-btn";
                    deleteBtn.onclick = () => deleteMessage(m.id); // utilise l'ID du message
                    tdActions.appendChild(deleteBtn);

                    tr.appendChild(tdDate);
                    tr.appendChild(tdNom);
                    tr.appendChild(tdMessage);
                    tr.appendChild(tdActions);

                    // Ajout en haut du tableau pour que le plus r√©cent soit visible
                    tbody.prepend(tr);
                });

            } catch (e) {
                console.error(e);
                alert('Erreur lors du chargement des messages');
            }
        }


        async function loadLogs() {
            try {
                const res = await fetch('/get-logs');
                const logs = await res.json();
                const tbody = document.getElementById("logsTableBody");
                tbody.innerHTML = "";

                if (!logs.length) {
                    tbody.innerHTML = `<tr><td style="text-align:center">Aucun log trouv√©</td></tr>`;
                    return;
                }

                // Trie du plus r√©cent au plus ancien
                const sorted = [...logs].sort((a, b) => new Date(b.date) - new Date(a.date));

                sorted.forEach(l => {
                    const tr = document.createElement("tr");

                    // Colonne Date & Action
                    const tdInfo = document.createElement("td");
                    tdInfo.textContent = `${l.date} - ${l.action}`;

                    // Colonne Actions (Supprimer)
                    const tdActions = document.createElement("td");
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Supprimer";
                    deleteBtn.className = "delete-btn";
                    deleteBtn.onclick = () => deleteLog(l.id); // utilise l'ID du log
                    tdActions.appendChild(deleteBtn);

                    tr.appendChild(tdInfo);
                    tr.appendChild(tdActions);

                    // Ajout en haut pour que le plus r√©cent soit visible
                    tbody.prepend(tr);
                });

            } catch (e) {
                console.error(e);
                alert('Erreur lors du chargement des logs');
            }
        }



        function populateCoursFilter(files) {
            const coursFilter = document.getElementById("coursFilter");
            const cours = [...new Set(files.map(f => f.cours))].sort();
            coursFilter.innerHTML = '<option value="">Tous les cours</option>';
            cours.forEach(c => coursFilter.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function displayFiles(files) {
            const tbody = document.getElementById("fileTableBody"); tbody.innerHTML = "";
            if (!files.length) { tbody.innerHTML = `<tr><td colspan="10" style="text-align:center">Aucun fichier trouv√©</td></tr>`; return; }
            const sorted = [...files].sort((a, b) => b.id - a.id);
            sorted.forEach(f => {
                const sizeMB = f.poidsFichier ? (f.poidsFichier / 1048576).toFixed(2) + ' MB' : 'N/A';
                const tr = document.createElement("tr");
  tr.innerHTML = `
  <td>${f.id}</td>
  <td>${f.annee || "N/A"}</td>
  <td>${f.anneeScolaire || "N/A"}</td>
  <td>${f.titre || "N/A"}</td>
  <td>${f.type ? f.type.toUpperCase() : "N/A"}</td>
  <td>${f.cours || "N/A"}</td>
  <td>${f.nomDiscord || "N/A"}</td>
  <td>${sizeMB}</td>
  <td>${f.dateAjout || "N/A"}</td>
  <td>${f.likes || 0}</td>
  <td>${f.dislikes || 0}</td>
  <td>
    <button class="edit-btn" onclick="editFile(${f.id})">Modifier</button>
    <button class="delete-btn" onclick="deleteFile(${f.id})">Supprimer</button>
  </td>`;
                tbody.appendChild(tr);
            });
        }

        function filterFiles() {
            const search = document.getElementById("searchInput").value.toLowerCase();
            const anneeFilter = document.getElementById("anneeFilter").value;
            const coursFilter = document.getElementById("coursFilter").value;
            const typeFilter = document.getElementById("typeFilter").value;
            const anneeScolaireFilter = document.getElementById("anneeScolaireFilter").value;

            const filtered = allFiles.filter(f => {
                const matchesS = f.titre.toLowerCase().includes(search) || f.cours.toLowerCase().includes(search) || (f.nomDiscord || "").toLowerCase().includes(search);
                const matchesA = !anneeFilter || String(f.annee) === anneeFilter;
                const matchesAS = !anneeScolaireFilter || f.anneeScolaire === anneeScolaireFilter;
                const matchesC = !coursFilter || f.cours === coursFilter;
                const matchesT = !typeFilter || f.type === typeFilter;
                return matchesS && matchesA && matchesAS && matchesC && matchesT;
            });
            displayFiles(filtered);
        }

        function editFile(id) {
            const f = allFiles.find(f => f.id === id); if (!f) return;
            document.getElementById("editId").value = f.id;
            document.getElementById("displayId").textContent = f.id;
            document.getElementById("editTitre").value = f.titre;
            document.getElementById("editNom").value = f.nomDiscord;
            document.getElementById("editDescription").value = f.description || "";
            document.getElementById("editAnnee").value = f.annee;
            document.getElementById("editAnneeScolaire").value = f.anneeScolaire || "2024-2025";
            fillCoursSelect(f.annee, f.cours);
            document.getElementById("editModal").style.display = "block";
            document.getElementById("editAnnee").onchange = function () { fillCoursSelect(this.value); };
        }
        function fillCoursSelect(annee, current = "") {
            const select = document.getElementById("editCours"); select.innerHTML = "";
            (coursParAnnee[annee] || []).forEach(c => {
                const opt = document.createElement("option"); opt.value = c; opt.textContent = c; if (c === current) opt.selected = true; select.appendChild(opt);
            });
        }
        function closeModal() { document.getElementById("editModal").style.display = "none"; }

        async function saveChanges() {
            const id = parseInt(document.getElementById("editId").value);
            const updates = {
                annee: parseInt(document.getElementById("editAnnee").value),
                anneeScolaire: document.getElementById("editAnneeScolaire").value.trim(),
                cours: document.getElementById("editCours").value.trim(),
                titre: document.getElementById("editTitre").value.trim(),
                nomDiscord: document.getElementById("editNom").value.trim(),
                description: document.getElementById("editDescription").value.trim()
            };
            try {
                const res = await fetch("/edit-file", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ id, ...updates }) });
                const data = await res.json();
                if (data.success) { loadFiles(); loadLogs(); closeModal(); alert("Fichier modifi√© avec succ√®s"); }
                else { alert("Erreur: " + data.message); }
            } catch (error) { alert("Erreur lors de la modification"); console.error(error); }
        }

        async function deleteFile(id) {
            if (!confirm("Voulez-vous vraiment supprimer ce fichier ?")) return;
            try {
                const res = await fetch(`/delete-file/${id}`, { method: "DELETE" });
                const data = await res.json();
                if (data.success) { loadFiles(); loadLogs(); alert("Fichier supprim√© avec succ√®s"); }
                else { alert("Erreur: " + data.message); }
            } catch { alert("Erreur lors de la suppression"); }
        }

        async function deleteLog(id) {
            if (!confirm("Voulez-vous vraiment supprimer ce log ?")) return;
            try {
                const res = await fetch(`/delete-log/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert("Log supprim√© !");
                    loadLogs(); // recharge la liste
                } else {
                    alert("Erreur : " + data.message);
                }
            } catch (e) {
                console.error(e);
                alert("Erreur lors de la suppression du log");
            }
        }


        async function deleteMessage(id) {
            if (!confirm("Voulez-vous vraiment supprimer ce message ?")) return;
            try {
                const res = await fetch(`/delete-message/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert("Message supprim√© !");
                    loadMessages(); // recharge la liste
                } else {
                    alert("Erreur : " + data.message);
                }
            } catch (e) {
                console.error(e);
                alert("Erreur lors de la suppression du message");
            }
        }





        async function sendMessage() {
            const nom = document.getElementById("messageNom").value.trim();
            const message = document.getElementById("messageText").value.trim();
            if (!nom || !message) { alert("Veuillez remplir tous les champs."); return; }
            if (nom.length > 50) { alert("Le nom ne doit pas d√©passer 50 caract√®res."); return; }
            if (message.length > 500) { alert("Le message ne doit pas d√©passer 500 caract√®res."); return; }
            try {
                const res = await fetch('/add-message', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nom, message }) });
                const data = await res.json();
                if (data.success) { alert("Message ajout√© avec succ√®s !"); document.getElementById("messageForm").reset(); loadMessages(); }
                else { alert("Erreur : " + data.message); }
            } catch (error) { alert("Erreur lors de l'envoi du message."); console.error(error); }
        }

        document.getElementById("anneeFilter").addEventListener("change", () => {
            const year = document.getElementById("anneeFilter").value;
            populateCoursFilter(allFiles.filter(f => !year || String(f.annee) === year));
            filterFiles();
        });
        document.getElementById("coursFilter").addEventListener("change", filterFiles);
        document.getElementById("typeFilter").addEventListener("change", filterFiles);
        document.getElementById("anneeScolaireFilter").addEventListener("change", filterFiles);
        let filterTimeout;
        document.getElementById("searchInput").addEventListener("input", () => {
            clearTimeout(filterTimeout); filterTimeout = setTimeout(filterFiles, 200);
        });
    </script>

    <script>
        document.getElementById('clearLogs').addEventListener('click', async () => {
            if (!confirm('Voulez-vous vraiment supprimer tous les logs ?')) return;

            try {
                const response = await fetch('/delete-all-logs', { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    // Recharge la liste des logs si tu as une fonction pour √ßa
                    if (typeof loadLogs === 'function') loadLogs();
                } else {
                    alert('Erreur : ' + result.message);
                }
            } catch (error) {
                console.error('Erreur suppression tous les logs:', error);
                alert('Erreur serveur');
            }
        });
    </script>

    <!-- Ton script de tri -->
<script>
    document.querySelectorAll(".file-table th").forEach((th, index) => {
        th.style.cursor = "pointer";
        th.addEventListener("click", () => {
            sortTableByColumn("fileTableBody", index);
        });
    });

    function sortTableByColumn(tbodyId, colIndex) {
        const tbody = document.getElementById(tbodyId);
        const table = tbody.closest("table");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        let currentDir = table.getAttribute(`data-sort-dir-${colIndex}`) || "desc";
        let asc = currentDir === "asc";

        rows.sort((a, b) => {
            const aText = a.cells[colIndex].textContent.trim().toLowerCase();
            const bText = b.cells[colIndex].textContent.trim().toLowerCase();

            const aNum = parseFloat(aText.replace(/[^\d.-]/g, ''));
            const bNum = parseFloat(bText.replace(/[^\d.-]/g, ''));
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return asc ? aNum - bNum : bNum - aNum;
            }

            if (aText < bText) return asc ? -1 : 1;
            if (aText > bText) return asc ? 1 : -1;
            return 0;
        });

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));

        table.setAttribute(`data-sort-dir-${colIndex}`, asc ? "desc" : "asc");
    }

    document.querySelectorAll('.collapse-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const body = btn.closest('.card').querySelector('.card-body');
        if(body.style.display === 'none') {
            body.style.display = 'block';
            btn.textContent = '‚ñ≤'; // fl√®che vers le haut
        } else {
            body.style.display = 'none';
            btn.textContent = '‚ñº'; // fl√®che vers le bas
        }
    });
});
</script>


    <script src="cookiesConsent.js"></script>
</body>

</html>